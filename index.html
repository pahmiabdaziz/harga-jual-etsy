<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tools Penentu Harga Jual Etsy</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#007bff">  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9f9f9;
      color: #222;
      padding: 20px;
      margin: 0;
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    .dark-mode { background-color: #121212; color: #eee; }
    .container {
      background-color: #fff;
      padding: 30px;
      max-width: 750px;
      margin: 30px auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    .dark-mode .container {
      background-color: #1e1e1e;
      box-shadow: 0 0 10px rgba(255,255,255,0.02);
    }
    h2 {
      text-align: center;
      margin-bottom: 4px;
      font-weight: 700;
      color: #007bff;
    }
    .dark-mode h2 { color: #3399ff; }
    .slogan {
      text-align: center;
      font-size: 0.95em;
      color: #777;
      margin-top: 0px;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      font-size: 0.95em;
    }
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ddd;
      border-radius: 8px;
      outline-color: #007bff;
      font-size: 14px;
    }
    button {
      margin-top: 18px;
      width: 100%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover { background-color: #0056b3; }
    .reset-button { background-color: #999; }
    .dark-mode .reset-button { background-color: #555; }
    .result {
      margin-top: 20px;
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    .result:hover { background: #dcefff; transform: scale(1.01); }
    .dark-mode .result { background: #2a2a2a; color: #eee; }
    .toggle-container {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      max-width: 750px;
      margin: -5px auto -10px auto;
      padding-right: 5px;
      gap: 8px;
      line-height: 1;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px; width: 18px;
      left: 3px; bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    .switch input:checked + .slider {
      background-color: #2196F3;
    }
    .switch input:checked + .slider:before {
      transform: translateX(26px);
    }
    .dark-toggle-label {
      display: flex;
      align-items: center;
      font-size: 0.85em;
      color: #555;
      margin-right: 5px;
      height: 24px;
    }
    .dark-mode .dark-toggle-label { color: #bbb; }
    .button-group {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      margin-top: 5px;
      padding-top: 5px;
      flex-wrap: nowrap;
    }
    .button-group button {
      flex: 1;
      width: 100%;
      max-width: 100%;
      padding: 10px;
      white-space: nowrap;
    }
    @media (max-width: 600px) {
      .container {
        padding: 20px;
        margin: 20px 10px;
      }
      h2 { font-size: 1.3em; }
      .slogan { font-size: 0.85em; }
      label { font-size: 0.9em; }
      input[type="number"] {
        font-size: 15px;
        padding: 8px;
      }
      button {
        font-size: 14px;
        padding: 10px;
      }
      .button-group { flex-direction: column; gap: 8px; }
      .toggle-container {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-right: 0;
        max-width: 100%;
        margin: -5px 0 -10px 0;
        gap: 8px;
        line-height: 1;
    }
  </style>
</head>
<body>

<!-- Dark Mode Toggle -->
<div class="toggle-container">
  <span class="dark-toggle-label" style="transform: translateY(5px);">
    üåô Mode Gelap
  </span>
  <label class="switch" style="transform: translateY(-1px);">
    <input type="checkbox" id="modeToggle" onchange="toggleDarkMode()">
    <span class="slider"></span>
  </label>
</div>

<!-- Main Container -->
<div class="container">
  <h2>TOOLS PENENTU HARGA JUAL ETSY</h2>
  <div class="slogan">
    Membantu Anda menentukan harga jual produk secara tepat dan menguntungkan
  </div>

  <!-- Kurs Realtime -->
  <div id="kursRealtime" style="text-align: center; font-size: 0.9em; color: #555; margin-top: -10px; margin-bottom: 30px;">
    Memuat kurs USD ke IDR...
  </div>

  <!-- Input Harga dan Biaya -->
  <label>Harga Pokok Produksi (Modal)</label>
  <input type="number" id="modal" placeholder="Contoh: 50000">

  <label>Biaya Tambahan Produksi</label>
  <input type="number" id="biayaTambahan" placeholder="Contoh: 10000">

  <!-- Margin Input -->
  <label>Margin (%)</label>
  <input type="number" id="margin" placeholder="Contoh: 20">

  <label>Markup (%)</label>
  <input type="number" id="markup" placeholder="Contoh: 50">

  <label>Diskon yang Akan Diberikan (%)</label>
  <input type="number" id="diskon" placeholder="Contoh: 10">

  <label>Biaya Kirim Internasional (Rp)</label>
  <input type="number" id="ongkir" placeholder="Contoh: 100000">

  <label>
    <input type="checkbox" id="freeShipping">
    Terapkan Free Shipping (Ongkir dimasukkan ke Harga Jual)
  </label>

  <!-- Biaya Etsy -->
  <label style="margin-top: 20px;">üíº Biaya Platform Etsy</label>

  <label>Listing Fee (USD)</label>
  <input type="number" id="listingUSD" value="0.2">

  <label>Transaction Fee (%)</label>
  <input type="number" id="trxFee" value="6.5">

  <label>Processing Fee (%)</label>
  <input type="number" id="procFee" value="4.5">

  <label>Biaya Tetap Pemrosesan (Rp)</label>
  <input type="number" id="procFlat" value="7000">

  <!-- Konversi Kurs -->
  <div class="form-group">
    <label for="konversi" style="display: block; font-weight: 600; font-size: 0.95em;">
      Conversion Currency Rate (%)
      <span style="font-weight: normal; font-size: 0.85em; color: #777;">
        <i>(Isi atau centang switch jika menggunakan mata uang IDR)</i>
      </span>
    </label>

    <div style="display: flex; align-items: center; gap: 8px;">
      <label class="switch" style="transform: scale(0.85) translateY(-7px) translateX(-1px);">
        <input type="checkbox" id="toggleKonversi" onchange="isiOtomatisKonversi()">
        <span class="slider"></span>
      </label>
      <span style="font-size: 0.88em; transform: translateY(1px) translateX(-3px);">Gunakan Konversi Otomatis</span>
    </div>

    <input type="number" id="konversi" placeholder="Contoh: 2,5" style="width: 100%; padding: 10px; font-size: 14px; border-radius: 8px; border: 1px solid #ccc;">
  </div>

  <!-- Tombol -->
  <button onclick="hitungHargaJual()">Hitung Harga Jual</button>
  <button class="reset-button" onclick="location.reload()">Reset</button>

  <!-- Hasil -->
  <div id="hasilContainer" style="display: none;">
    <div class="result" id="hasil" style="margin-top: 25px;"></div>
    <button onclick="salinTeks(hasilTeks)">üìã Salin Hasil Ini</button>
  </div>

  <!-- Riwayat -->
  <div class="hasil-dan-riwayat">
    <div id="tombolRiwayat" class="button-group" style="display: none;">
      <button onclick="simpanKeLocalStorage()">üíæ Simpan Hasil</button>
      <button onclick="hapusRiwayat()" class="reset-button">üóëÔ∏è Hapus Riwayat</button>
    </div>
    <div id="riwayatHasil" class="result" style="margin-top: 25px;">
      <em>Tidak ada hasil yang tersimpan.</em>
    </div>
  </div>
</div>

<script>
/* Toggle Dark Mode */
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

/* Ambil Kurs Realtime USD ‚Üí IDR */
async function getRealtimeUSD() {
  try {
    const res = await fetch("https://open.er-api.com/v6/latest/USD");
    const data = await res.json();
    const rate = data.rates.IDR;
    document.getElementById("kursRealtime").innerText = `Kurs USD ke IDR saat ini: Rp${rate.toLocaleString()}`;
    return rate;
  } catch (e) {
    const fallbackRate = 16000;
    document.getElementById("kursRealtime").innerText =
      `Kurs USD ke IDR tidak tersedia, menggunakan nilai default Rp${fallbackRate.toLocaleString()}`;
    return fallbackRate;
  }
}

/* Switch Otomatis Konversi */
function isiOtomatisKonversi() {
  const toggle = document.getElementById("toggleKonversi");
  const input = document.getElementById("konversi");

  if (toggle.checked) {
    input.value = "2.5";
    input.setAttribute("readonly", true);
    input.style.backgroundColor = "#eee";
  } else {
    input.removeAttribute("readonly");
    input.value = "";
    input.style.backgroundColor = "";
  }
}

/* Variabel Global untuk Riwayat */
let hasilTerakhir = "";

/* Hitung Harga Jual Etsy */
async function hitungHargaJual() {
  // Ambil semua input
  const modal = parseFloat(document.getElementById('modal').value) || 0;
  const tambahan = parseFloat(document.getElementById('biayaTambahan').value) || 0;
  const margin = parseFloat(document.getElementById('margin').value) || 0;
  const markup = parseFloat(document.getElementById('markup').value) || 0;
  const diskon = parseFloat(document.getElementById('diskon').value) || 0;
  const ongkir = parseFloat(document.getElementById('ongkir').value) || 0;
  const listingUSD = parseFloat(document.getElementById('listingUSD').value) || 0;
  const trxFee = (parseFloat(document.getElementById('trxFee').value) || 0) / 100;
  const procFee = (parseFloat(document.getElementById('procFee').value) || 0) / 100;
  const procFlat = parseFloat(document.getElementById('procFlat').value) || 0;
  const konversi = (parseFloat(document.getElementById('konversi').value) || 0) / 100;
  const isFreeShipping = document.getElementById('freeShipping').checked;

  const kurs = await getRealtimeUSD();

  // Perhitungan Dasar
  const totalModal = modal + tambahan;
  const nilaiMargin = totalModal * (margin / 100);

  // Hitung harga jual (sebelum diskon) berdasarkan kombinasi margin & markup
  let hargaSebelumDiskon = 0;
  let metodePenentuanHarga = "";

  if (margin === 0 && markup === 0) {
    hargaSebelumDiskon = totalModal;
    metodePenentuanHarga = "-";
  } else if (margin > 0 && markup === 0) {
    hargaSebelumDiskon = totalModal + nilaiMargin;
    metodePenentuanHarga = `Margin (${margin}%)`;
  } else if (margin === 0 && markup > 0) {
    hargaSebelumDiskon = totalModal * (1 + markup / 100);
    metodePenentuanHarga = `Markup (${markup}%)`;
  } else {
    hargaSebelumDiskon = (totalModal + nilaiMargin) * (1 + markup / 100);
    metodePenentuanHarga = `Margin + Markup`;
  }

  // Nilai markup aktual (yang dihasilkan)
  const nilaiMarkup = hargaSebelumDiskon - (totalModal + nilaiMargin);

  // Tambah ongkir ke harga jual jika Free Shipping
  if (isFreeShipping) hargaSebelumDiskon += ongkir;

  const hargaSetelahDiskon = hargaSebelumDiskon - (hargaSebelumDiskon * diskon / 100);
  const subtotal = hargaSebelumDiskon + (isFreeShipping ? 0 : ongkir);

  // Biaya-biaya
  const biayaListing = listingUSD * kurs;
  const biayaTrx = subtotal * trxFee;
  const biayaProc = subtotal * procFee + procFlat;
  const biayaKonversi = subtotal * konversi;
  const totalPotongan = biayaListing + biayaTrx + biayaProc + biayaKonversi;

  // Hasil Akhir
  const hargaFinal = hargaSebelumDiskon + totalPotongan;
  const keuntunganBersih = hargaSetelahDiskon - totalModal - totalPotongan;

  // Emoji Lencana Berdasarkan Keuntungan
  const badge = keuntunganBersih >= 20000 ? "üí∞" : (keuntunganBersih >= 5000 ? "‚ö†Ô∏è" : "‚ùå");

  // Format Hasil HTML
  hasilTerakhir = `
    <strong style="font-size: 1.1em; display: block; margin-bottom: 15px; color: #007bff;">üìä Rincian Perhitungan</strong>
    <strong>Total Modal:</strong> Rp${totalModal.toLocaleString()}<br>
    <strong>Margin (${margin}%):</strong> Rp${nilaiMargin.toLocaleString()}<br>
    <strong>Markup (${markup}%):</strong> Rp${nilaiMarkup.toLocaleString()}<br>
    <strong>Metode Penentuan Harga:</strong> ${metodePenentuanHarga}<br><br>

    <strong>Harga Sebelum Diskon:</strong> Rp${hargaSebelumDiskon.toLocaleString()} | $${(hargaSebelumDiskon / kurs).toFixed(2)}<br>
    <strong>Harga Setelah Diskon:</strong> Rp${hargaSetelahDiskon.toLocaleString()} | $${(hargaSetelahDiskon / kurs).toFixed(2)}<br><br>

    <strong>Biaya Platform Etsy:</strong><br>
    - Listing Fee ($${listingUSD}): Rp${biayaListing.toLocaleString()}<br>
    - Transaction Fee (${(trxFee * 100).toFixed(1)}%): Rp${biayaTrx.toLocaleString()}<br>
    - Processing Fee (${(procFee * 100).toFixed(1)}% + Rp${procFlat.toLocaleString()}): Rp${biayaProc.toLocaleString()}<br>
    - Currency Conversion (${(konversi * 100).toFixed(1)}%): Rp${biayaKonversi.toLocaleString()}<br><br>

    <strong>Total Potongan:</strong> Rp${totalPotongan.toLocaleString()}<br><br>

    <strong>Keuntungan Bersih:</strong> <span style="color: ${keuntunganBersih >= 0 ? 'green' : 'red'}">${badge} Rp${keuntunganBersih.toLocaleString()}</span><br>
    <strong><u>Harga Jual yang Harus Dipasang:</u></strong>
    <span style="color: green; font-weight: bold;">Rp${hargaFinal.toLocaleString()} | $${(hargaFinal / kurs).toFixed(2)}</span>
  `;

  document.getElementById("hasil").innerHTML = hasilTerakhir;
  document.getElementById("hasilContainer").style.display = "block";
  document.getElementById("tombolRiwayat").style.display = "flex";

  // Versi teks murni untuk clipboard
  hasilTeks = `
Total Modal: Rp${totalModal.toLocaleString()}
Margin (${margin}%): Rp${nilaiMargin.toLocaleString()}
Markup (${markup}%): Rp${nilaiMarkup.toLocaleString()}
Metode Penentuan Harga: ${metodePenentuanHarga}

Harga Sebelum Diskon: Rp${hargaSebelumDiskon.toLocaleString()} | $${(hargaSebelumDiskon / kurs).toFixed(2)}
Harga Setelah Diskon: Rp${hargaSetelahDiskon.toLocaleString()} | $${(hargaSetelahDiskon / kurs).toFixed(2)}

Biaya Platform Etsy:
- Listing Fee ($${listingUSD}): Rp${biayaListing.toLocaleString()}
- Transaction Fee (${(trxFee * 100).toFixed(1)}%): Rp${biayaTrx.toLocaleString()}
- Processing Fee (${(procFee * 100).toFixed(1)}% + Rp${procFlat.toLocaleString()}): Rp${biayaProc.toLocaleString()}
- Currency Conversion (${(konversi * 100).toFixed(1)}%): Rp${biayaKonversi.toLocaleString()}

Total Potongan: Rp${totalPotongan.toLocaleString()}

Keuntungan Bersih: Rp${keuntunganBersih.toLocaleString()}
Harga Jual yang Harus Dipasang: Rp${hargaFinal.toLocaleString()} | $${(hargaFinal / kurs).toFixed(2)}
  `;
}

/* Simpan ke LocalStorage */
function simpanKeLocalStorage() {
  if (!hasilTerakhir.trim()) return alert("Belum ada hasil untuk disimpan!");
  const waktu = new Date().toLocaleString("id-ID");
  const data = { waktu, hasil: hasilTerakhir };

  let riwayat = JSON.parse(localStorage.getItem("riwayatHasilEtsy")) || [];
  riwayat.unshift(data);
  localStorage.setItem("riwayatHasilEtsy", JSON.stringify(riwayat.slice(0, 5)));
  alert("‚úÖ Hasil telah disimpan ke Local Storage!");
  tampilkanRiwayat();
}

/* Tampilkan Riwayat */
function tampilkanRiwayat() {
  const riwayat = JSON.parse(localStorage.getItem("riwayatHasilEtsy")) || [];
  const container = document.getElementById("riwayatHasil");

  if (!riwayat.length) {
    container.innerHTML = `<em style="display:block; text-align:center; font-size:0.9em; color:#777;">Tidak ada hasil yang tersimpan.</em>`;
    return;
  }

  container.innerHTML = `<strong>üìã Riwayat Hasil Tersimpan:</strong><br><br>` +
    riwayat.map(item => `
      <div style="margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">
        <div style="font-size: 0.85em; color: #888;">üïí ${item.waktu}</div>
        <div>${item.hasil}</div>
        <button onclick="salinDariElemen(this)">üìã Salin Hasil Ini</button>
      </div>
    `).join("");
}

/* Salin dari HTML Element */
function salinDariElemen(tombol) {
  const hasilHTML = tombol.previousElementSibling?.innerText || "";
  salinTeks(hasilHTML);
}

/* Salin ke Clipboard */
function salinTeks(teks) {
  const el = document.createElement("textarea");
  el.value = teks
    .split('\n')
    .map(baris => baris.trimStart())
    .join('\n')
    .trim();
  document.body.appendChild(el);
  el.select();
  document.execCommand("copy");
  document.body.removeChild(el);
  alert("üìã Hasil telah disalin ke clipboard!");
}

/* Hapus Semua Riwayat */
function hapusRiwayat() {
  if (confirm("Yakin ingin menghapus semua riwayat kalkulasi?")) {
    localStorage.removeItem("riwayatHasilEtsy");
    alert("Riwayat berhasil dihapus.");
    location.reload();
  }
}

/* Register Service Worker untuk PWA */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function (registration) {
        console.log('‚úÖ ServiceWorker terdaftar: ', registration.scope);
      })
      .catch(function (err) {
        console.log('‚ùå ServiceWorker gagal: ', err);
      });
  });
}

/* Load Riwayat Saat Halaman Dibuka */
document.addEventListener("DOMContentLoaded", tampilkanRiwayat);
</script>

</body>
</html>
