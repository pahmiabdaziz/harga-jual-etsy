// ===========================
// üìå PERHITUNGAN HARGA JUAL
// ===========================

// 1. Total Modal (HPP): terdiri dari harga modal + tambahan (misal bahan, biaya produksi lain)
const totalModal = modal + tambahan;

// 2. Hitung nilai margin sebagai profit minimal yang harus tetap aman
const nilaiMargin = totalModal * (margin / 100);

// 3. Tambahkan margin ke modal
const modalPlusMargin = totalModal + nilaiMargin;

// 4. Terapkan markup di atas (modal + margin)
// Tujuan: markup digunakan sebagai ruang diskon strategi
let hargaSebelumDiskon = modalPlusMargin * (1 + markup / 100);

// 5. Hitung berapa nilai markup aktual yang terbentuk
const nilaiMarkup = hargaSebelumDiskon - modalPlusMargin;

// 6. Jika menggunakan strategi Free Shipping, ongkir ditambahkan ke harga jual
if (isFreeShipping) hargaSebelumDiskon += ongkir;

// 7. Hitung harga setelah diskon (misal: 30% diskon untuk menarik pembeli)
const hargaSetelahDiskon = hargaSebelumDiskon - (hargaSebelumDiskon * diskon / 100);

// 8. Subtotal untuk fee platform: jika tidak free shipping, ongkir masuk di subtotal
const subtotal = hargaSebelumDiskon + (isFreeShipping ? 0 : ongkir);

// ===========================
// üì¶ BIAYA-BIAYA DI PLATFORM ETSY
// ===========================

const biayaListing = listingUSD * kurs;                                // Listing Fee (konversi dari USD)
const biayaTrx = subtotal * trxFee;                                    // Transaction Fee (misal 6.5%)
const biayaProc = subtotal * procFee + procFlat;                       // Processing Fee (misal 4.5% + Rp7000)
const biayaKonversi = subtotal * konversi;                             // Currency conversion fee (misal 2.5%)
const totalPotongan = biayaListing + biayaTrx + biayaProc + biayaKonversi; // Total biaya platform

// ===========================
// üí∞ KEUNTUNGAN DAN HARGA FINAL
// ===========================

const hargaFinal = hargaSebelumDiskon + totalPotongan; // Harga jual sebelum diskon + potongan Etsy
const keuntunganBersih = hargaSetelahDiskon - totalModal - totalPotongan; // Profit bersih setelah semua potongan

// üèÖ Lencana (Badge) untuk indikasi profit
const badge = keuntunganBersih >= 20000 ? "üí∞" : (keuntunganBersih >= 5000 ? "‚ö†Ô∏è" : "‚ùå");

// ===========================
// üìÑ OUTPUT HTML (VISUAL)
// ===========================

hasilTerakhir = `
  <strong style="font-size: 1.1em; display: block; margin-bottom: 15px; color: #007bff;">üìä Rincian Perhitungan</strong>
  <strong>Total Modal:</strong> Rp${totalModal.toLocaleString()}<br>
  <strong>Margin (${margin}%):</strong> Rp${nilaiMargin.toLocaleString()}<br>
  <strong>Markup (${markup}%):</strong> Rp${nilaiMarkup.toLocaleString()}<br><br>

  <strong>Harga Sebelum Diskon:</strong> Rp${hargaSebelumDiskon.toLocaleString()} | $${(hargaSebelumDiskon / kurs).toFixed(2)}<br>
  <strong>Harga Setelah Diskon:</strong> Rp${hargaSetelahDiskon.toLocaleString()} | $${(hargaSetelahDiskon / kurs).toFixed(2)}<br><br>

  <strong>Biaya Platform Etsy:</strong><br>
  - Listing Fee ($${listingUSD}): Rp${biayaListing.toLocaleString()}<br>
  - Transaction Fee (${(trxFee * 100).toFixed(1)}%): Rp${biayaTrx.toLocaleString()}<br>
  - Processing Fee (${(procFee * 100).toFixed(1)}% + Rp${procFlat.toLocaleString()}): Rp${biayaProc.toLocaleString()}<br>
  - Currency Conversion (${(konversi * 100).toFixed(1)}%): Rp${biayaKonversi.toLocaleString()}<br><br>

  <strong>Total Potongan:</strong> Rp${totalPotongan.toLocaleString()}<br><br>

  <strong>Keuntungan Bersih:</strong> <span style="color: ${keuntunganBersih >= 0 ? 'green' : 'red'}">${badge} Rp${keuntunganBersih.toLocaleString()}</span><br>
  <strong><u>Harga Jual yang Harus Dipasang:</u></strong>
  <span style="color: green; font-weight: bold;">Rp${hargaFinal.toLocaleString()} | $${(hargaFinal / kurs).toFixed(2)}</span>
`;

document.getElementById("hasil").innerHTML = hasilTerakhir;
document.getElementById("hasilContainer").style.display = "block";
document.getElementById("tombolRiwayat").style.display = "flex";

// ===========================
// üìã VERSI TEKS UNTUK CLIPBOARD
// ===========================

hasilTeks = `
Total Modal: Rp${totalModal.toLocaleString()}
Margin (${margin}%): Rp${nilaiMargin.toLocaleString()}
Markup (${markup}%): Rp${nilaiMarkup.toLocaleString()}

Harga Sebelum Diskon: Rp${hargaSebelumDiskon.toLocaleString()} | $${(hargaSebelumDiskon / kurs).toFixed(2)}
Harga Setelah Diskon: Rp${hargaSetelahDiskon.toLocaleString()} | $${(hargaSetelahDiskon / kurs).toFixed(2)}

Biaya Platform Etsy:
- Listing Fee ($${listingUSD}): Rp${biayaListing.toLocaleString()}
- Transaction Fee (${(trxFee * 100).toFixed(1)}%): Rp${biayaTrx.toLocaleString()}
- Processing Fee (${(procFee * 100).toFixed(1)}% + Rp${procFlat.toLocaleString()}): Rp${biayaProc.toLocaleString()}
- Currency Conversion (${(konversi * 100).toFixed(1)}%): Rp${biayaKonversi.toLocaleString()}

Total Potongan: Rp${totalPotongan.toLocaleString()}

Keuntungan Bersih: Rp${keuntunganBersih.toLocaleString()}
Harga Jual yang Harus Dipasang: Rp${hargaFinal.toLocaleString()} | $${(hargaFinal / kurs).toFixed(2)}
`;

// ===========================
// üíæ SIMPAN KE LOCALSTORAGE
// ===========================

function simpanKeLocalStorage() {
  if (!hasilTerakhir.trim()) return alert("Belum ada hasil untuk disimpan!");

  const waktu = new Date().toLocaleString("id-ID");
  const data = { waktu, hasil: hasilTerakhir };

  let riwayat = JSON.parse(localStorage.getItem("riwayatHasilEtsy")) || [];
  riwayat.unshift(data); // Tambah ke awal
  localStorage.setItem("riwayatHasilEtsy", JSON.stringify(riwayat.slice(0, 5))); // Simpan hanya 5 terakhir

  alert("‚úÖ Hasil telah disimpan ke Local Storage!");
  tampilkanRiwayat(); // Refresh tampilan riwayat
}
